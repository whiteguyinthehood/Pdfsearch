<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>DocuSearch Knowledge</title>
    
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3143/3143460.png">

    <!-- LIBRARIES -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>

    <style>
      .pt-safe-top { padding-top: env(safe-area-inset-top); }
      .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.75rem; }
      .magic-link { transition: all 0.2s; }
      .magic-link:active { background-color: #e0e7ff; transform: scale(1.05); display: inline-block; }
      .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900 select-none">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo, useCallback } = React;
      const { createRoot } = ReactDOM;
      
      const Icon = ({ path, size = 20, className = "", ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" 
          fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
          className={className} {...props} dangerouslySetInnerHTML={{ __html: path }} />
      );
      
      const ICONS = {
        search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
        upload: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>',
        arrowLeft: '<line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>',
        trash: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>',
        grid: '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>',
        list: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>',
        tag: '<path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>',
        settings: '<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>',
        download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>',
        speaker: '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>',
        stop: '<rect x="6" y="6" width="12" height="12"></rect>',
        listIcon: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>',
        star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>',
        starFilled: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor"></polygon>',
        edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>',
        check: '<polyline points="20 6 9 17 4 12"></polyline>'
      };

      const DB_NAME = 'DocuSearch_Knowledge_V2';
      const STORE_NAME = 'files_store';
      const PDFJS_CDN = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
      const PDFJS_WORKER_CDN = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      const BATCH_SIZE = 3;

      // --- SMART TEXT CLEANER ---
      const cleanText = (str) => {
        if (!str) return "";
        return str
          .replace(/-\s+([a-z])/g, '$1') // Fix hyphenation
          .replace(/ﬀ/g, 'ff').replace(/ﬁ/g, 'fi').replace(/ﬂ/g, 'fl').replace(/ﬃ/g, 'ffi').replace(/ﬄ/g, 'ffl') // Fix ligatures
          .replace(/[\x00-\x09\x0B-\x0C\x0E-\x1F]/g, '') // Remove control chars
          .replace(/[ \t]{2,}/g, ' ') // Collapse spaces
          .replace(/([a-z,])\n([a-z])/g, '$1 $2') // Normalize newlines
          .trim();
      };

      function App() {
        const [files, setFiles] = useState([]); 
        const [savedSearches, setSavedSearches] = useState([]); 
        const [processingQueue, setProcessingQueue] = useState([]);
        const [isProcessing, setIsProcessing] = useState(false);
        const [viewMode, setViewMode] = useState('list'); 
        const [searchQuery, setSearchQuery] = useState('');
        const [searchResults, setSearchResults] = useState([]);
        const [selectedFile, setSelectedFile] = useState(null);
        const [statusMsg, setStatusMsg] = useState('');
        const [isViewerOpen, setIsViewerOpen] = useState(false);
        const [showSettings, setShowSettings] = useState(false);
        const [showSavedSearches, setShowSavedSearches] = useState(false);
        const [showToC, setShowToC] = useState(false);
        const [activeTagFilter, setActiveTagFilter] = useState(null);
        const [isSpeaking, setIsSpeaking] = useState(false);
        const [isEditingKeywords, setIsEditingKeywords] = useState(false);
        const [keywordToEdit, setKeywordToEdit] = useState(null);
        const [deferredPrompt, setDeferredPrompt] = useState(null);

        const fileInputRef = useRef(null);
        const importInputRef = useRef(null);

        useEffect(() => {
          const script = document.createElement('script');
          script.src = PDFJS_CDN;
          script.onload = () => window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_CDN;
          document.body.appendChild(script);
          
          if ('serviceWorker' in navigator) {
             navigator.serviceWorker.register('./service-worker.js');
          }
          window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setDeferredPrompt(e); });

          loadLibraryFromDB();
          const saved = localStorage.getItem('docusearch_keywords_v2');
          if(saved) setSavedSearches(JSON.parse(saved));
        }, []);

        const installApp = async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') setDeferredPrompt(null);
        };

        const saveKeyword = (obj) => {
           const newK = savedSearches.some(k=>k.id===obj.id) ? savedSearches.map(k=>k.id===obj.id?obj:k) : [...savedSearches, obj];
           setSavedSearches(newK);
           localStorage.setItem('docusearch_keywords_v2', JSON.stringify(newK));
        };
        const deleteKeyword = (id) => {
           const newK = savedSearches.filter(k=>k.id!==id);
           setSavedSearches(newK);
           localStorage.setItem('docusearch_keywords_v2', JSON.stringify(newK));
        };
        const toggleQuickSave = (term) => {
           if(!term.trim()) return;
           const exists = savedSearches.find(s => s.term.toLowerCase() === term.toLowerCase());
           if (exists) deleteKeyword(exists.id);
           else saveKeyword({ id: Math.random().toString(36).substr(2,9), term, category: 'General', important: false });
        };

        useEffect(() => { if (processingQueue.length > 0 && !isProcessing) processNextBatch(); }, [processingQueue, isProcessing]);

        const processNextBatch = async () => {
          setIsProcessing(true);
          const batch = processingQueue.slice(0, BATCH_SIZE);
          const remaining = processingQueue.slice(BATCH_SIZE);
          for (const file of batch) await processSingleFile(file, processingQueue.length);
          setProcessingQueue(remaining);
          if (remaining.length === 0) { setStatusMsg("Done!"); setTimeout(() => setStatusMsg(''), 3000); }
          setIsProcessing(false);
        };

        const processSingleFile = async (file, remainingCount) => {
           try {
             const fileId = `${file.name}-${file.size}`;
             if (files.some(f => f.id === fileId)) return;
             setStatusMsg(`Processing: ${file.name} (${remainingCount} left)`);
             const url = URL.createObjectURL(file);
             const loadingTask = window.pdfjsLib.getDocument(url);
             const pdf = await loadingTask.promise;
             let thumbData = null;
             try {
               const page1 = await pdf.getPage(1);
               const viewport = page1.getViewport({ scale: 0.5 });
               const canvas = document.createElement('canvas');
               canvas.width = viewport.width;
               canvas.height = viewport.height;
               await page1.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
               thumbData = canvas.toDataURL('image/jpeg', 0.6);
             } catch(e) {}
             let toc = [];
             try { const outline = await pdf.getOutline(); if(outline) toc = await processOutline(pdf, outline); } catch(e) {}
             
             // EXTRACT & CLEAN TEXT
             const extractedText = [];
             for (let i = 1; i <= pdf.numPages; i++) {
               const page = await pdf.getPage(i);
               const content = await page.getTextContent();
               const rawStr = content.items.map(item => item.str).join(' ');
               extractedText.push(rawStr.trim().length > 0 ? cleanText(rawStr) : "[Image]");
             }

             const finalData = { id: fileId, name: file.name, pageCount: pdf.numPages, textContent: extractedText, toc, thumbnail: thumbData, tags: [], added: Date.now() };
             await saveFileToDB(finalData);
             setFiles(prev => [finalData, ...prev]);
             URL.revokeObjectURL(url);
           } catch (err) { console.error(err); }
        };

        const openDB = () => new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, 1); r.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' }); }; r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); });
        const loadLibraryFromDB = async () => { try { const db = await openDB(); const tx = db.transaction(STORE_NAME, 'readonly'); const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => setFiles(req.result.sort((a,b) => b.added - a.added)); } catch(e) {} };
        const saveFileToDB = async (data) => { const db = await openDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).put(data); };
        const updateFileInDB = async (fileId, updates) => { const db = await openDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); store.get(fileId).onsuccess = (e) => { store.put({ ...e.target.result, ...updates }); setFiles(prev => prev.map(f => f.id === fileId ? { ...f, ...updates } : f)); if(selectedFile?.id === fileId) setSelectedFile(prev => ({...prev, ...updates})); }; };
        const processOutline = async (pdfDoc, items) => { const processed = []; for (const item of items) { let page = 1; try { if (item.dest) { const dest = typeof item.dest === 'string' ? await pdfDoc.getDestination(item.dest) : item.dest; if (dest) { const ref = dest[0]; const index = await pdfDoc.getPageIndex(ref); page = index + 1; } } } catch(e) {} const children = item.items?.length ? await processOutline(pdfDoc, item.items) : []; processed.push({ title: item.title, page, children }); } return processed; };

        const handleFileSelect = (e) => { if (!window.pdfjsLib) return alert("Engine loading..."); const newFiles = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.pdf')); if (newFiles.length === 0) return; setProcessingQueue(prev => [...prev, ...newFiles]); };
        const handleView = (fileId, page = 1) => { const f = files.find(x => x.id === fileId); if (f) { setSelectedFile({...f, page}); setIsViewerOpen(true); setShowToC(false); } };
        const handleKeywordClick = (keyword) => { setIsViewerOpen(false); setSearchQuery(keyword); };

        useEffect(() => {
           if (!searchQuery.trim()) { setSearchResults([]); return; }
           const fuse = new Fuse(files, { keys: ['name', 'textContent', 'tags'], threshold: 0.3 });
           const res = fuse.search(searchQuery).map(r => {
              const item = r.item;
              let snippet = "";
              let page = 1;
              item.textContent.forEach((txt, i) => { if (txt.toLowerCase().includes(searchQuery.toLowerCase())) { snippet = txt.substring(Math.max(0, txt.toLowerCase().indexOf(searchQuery.toLowerCase())-30), txt.length).substring(0, 80); page = i + 1; } });
              return { fileId: item.id, fileName: item.name, page, snippet: snippet || "Match", thumbnail: item.thumbnail };
           });
           setSearchResults(res);
        }, [searchQuery, files]);

        const addTag = (t) => { if(t && selectedFile){ const nt=[...new Set([...(selectedFile.tags||[]), t])]; updateFileInDB(selectedFile.id, {tags:nt}); }};
        const removeTag = (t) => { if(selectedFile){ const nt=selectedFile.tags.filter(x=>x!==t); updateFileInDB(selectedFile.id, {tags:nt}); }};
        const speakText = () => { if(isSpeaking) { window.speechSynthesis.cancel(); setIsSpeaking(false); return; } if(!selectedFile) return; const txt = selectedFile.textContent[(selectedFile.page||1)-1]; if(!txt || txt==="[Image]") return alert("No text."); const u = new SpeechSynthesisUtterance(txt); u.onend = () => setIsSpeaking(false); setIsSpeaking(true); window.speechSynthesis.speak(u); };
        useEffect(() => { return () => window.speechSynthesis.cancel(); }, [selectedFile]);

        const ToCList = ({ items, level = 0 }) => ( <div>{items.map((it, i) => ( <div key={i}> <button onClick={() => {setSelectedFile(p=>({...p, page:it.page})); setShowToC(false);}} className="text-left py-3 px-4 w-full border-b border-slate-50 hover:bg-slate-50 text-sm truncate" style={{paddingLeft: `${level*16+16}px`}}> <span className="font-medium">{it.title}</span> <span className="text-xs text-slate-400 ml-2">(Pg {it.page})</span> </button> {it.children && <ToCList items={it.children} level={level+1} />} </div> ))}</div> );

        const HighlightedText = ({ text, keywords, onLinkClick }) => {
           if (!text) return null;
           if (!keywords || keywords.length === 0) return <p className="text-lg leading-loose text-slate-800 font-serif whitespace-pre-wrap">{text}</p>;
           const terms = keywords.map(k => k.term);
           const pattern = new RegExp(`(${terms.sort((a,b)=>b.length-a.length).map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')})`, 'gi');
           const parts = text.split(pattern);
           return (
              <p className="text-lg leading-loose text-slate-800 font-serif whitespace-pre-wrap">
                 {parts.map((part, i) => {
                    const match = keywords.find(k => k.term.toLowerCase() === part.toLowerCase());
                    if (match) {
                       return <span key={i} onClick={(e) => { e.stopPropagation(); onLinkClick(part); }} className={`font-bold underline cursor-pointer magic-link ${match.important ? 'text-amber-600 decoration-amber-400 decoration-4' : 'text-indigo-600 decoration-indigo-300 decoration-2'}`}>{part}</span>;
                    }
                    return part;
                 })}
              </p>
           );
        };

        const groupedKeywords = useMemo(() => {
           const groups = {};
           groups['Priority'] = savedSearches.filter(s => s.important);
           savedSearches.forEach(s => {
              if (s.important) return;
              const cat = s.category || 'General';
              if (!groups[cat]) groups[cat] = [];
              groups[cat].push(s);
           });
           return groups;
        }, [savedSearches]);

        const filteredFiles = files.filter(f => activeTagFilter ? f.tags?.includes(activeTagFilter) : true);
        const allTags = [...new Set(files.flatMap(f => f.tags || []))];

        return (
          <div className="flex flex-col h-[100dvh] bg-slate-50 text-slate-900 overflow-hidden font-sans">
            
            <div className="pt-safe-top bg-white border-b border-slate-200 pb-2 px-4 flex items-end justify-between shadow-sm z-20">
               <div className="flex items-center gap-2 mt-3">
                  <div className="bg-indigo-600 p-1.5 rounded-lg text-white cursor-pointer" onClick={() => setShowSettings(!showSettings)}><Icon path={ICONS.settings} size={20} /></div>
                  <h1 className="font-bold text-lg leading-none">DocuSearch <span className="text-indigo-600">Clean</span></h1>
               </div>
               <div className="flex gap-3">
                  <button onClick={() => setShowSavedSearches(!showSavedSearches)} className={`p-1 ${showSavedSearches ? 'text-indigo-600' : 'text-slate-500'}`}><Icon path={ICONS.tag} size={22} /></button>
                  <button onClick={() => setViewMode(viewMode==='list'?'grid':'list')} className="text-slate-500 p-1"><Icon path={viewMode==='list'?ICONS.grid:ICONS.list} /></button>
               </div>
            </div>

            {showSavedSearches && (
               <div className="absolute inset-x-0 top-[4rem] bg-slate-50 border-b border-slate-200 shadow-xl z-30 max-h-[60vh] overflow-y-auto animate-in slide-in-from-top-2 flex flex-col">
                  <div className="p-3 border-b border-slate-200 bg-white flex justify-between items-center sticky top-0 z-10">
                     <h3 className="text-xs font-bold text-slate-500 uppercase">Knowledge Graph</h3>
                     <button onClick={() => setIsEditingKeywords(!isEditingKeywords)} className={`text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1 ${isEditingKeywords ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}`}><Icon path={ICONS.edit} size={12} /> Manage</button>
                  </div>
                  <div className="p-4 space-y-4">
                     {savedSearches.length === 0 && <p className="text-sm text-slate-400 italic text-center">Star a search term to add it here.</p>}
                     {Object.entries(groupedKeywords).map(([category, items]) => (
                        items.length > 0 && (
                           <div key={category}>
                              <h4 className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-wider">{category}</h4>
                              <div className="flex flex-wrap gap-2">
                                 {items.map(k => (
                                    <button key={k.id} onClick={() => { if(isEditingKeywords) { setKeywordToEdit(k); } else { setSearchQuery(k.term); setShowSavedSearches(false); }}} className={`flex items-center gap-1 px-3 py-1.5 border rounded-full text-sm font-medium shadow-sm transition-all ${k.important ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-white border-slate-200 text-slate-700'} ${isEditingKeywords ? 'hover:bg-indigo-50 hover:border-indigo-300' : 'active:scale-95'}`}>
                                       {k.important && <Icon path={ICONS.starFilled} size={10} className="text-amber-500" />} {k.term} {isEditingKeywords && <Icon path={ICONS.edit} size={10} className="ml-1 opacity-50" />}
                                    </button>
                                 ))}
                              </div>
                           </div>
                        )
                     ))}
                  </div>
               </div>
            )}

            {keywordToEdit && (
               <div className="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl slide-up">
                     <h3 className="font-bold text-lg mb-4">Edit Keyword</h3>
                     <div className="space-y-4">
                        <div><label className="text-xs font-bold text-slate-400 uppercase">Term</label><input type="text" value={keywordToEdit.term} onChange={(e) => setKeywordToEdit({...keywordToEdit, term: e.target.value})} className="w-full p-2 border rounded-lg font-bold text-slate-800" /></div>
                        <div>
                           <label className="text-xs font-bold text-slate-400 uppercase">Category</label>
                           <select value={keywordToEdit.category} onChange={(e) => setKeywordToEdit({...keywordToEdit, category: e.target.value})} className="w-full p-3 border rounded-lg text-slate-700 bg-white appearance-none font-medium">
                              <option value="General">General</option>
                              <option value="Finance">Finance</option>
                              <option value="People">People</option>
                              <option value="Technical">Technical</option>
                              <option value="Work">Work</option>
                              <option value="Personal">Personal</option>
                              <option value="Legal">Legal</option>
                              <option value="Medical">Medical</option>
                           </select>
                        </div>
                        <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer" onClick={() => setKeywordToEdit({...keywordToEdit, important: !keywordToEdit.important})}>
                           <div className={`w-5 h-5 rounded border flex items-center justify-center ${keywordToEdit.important ? 'bg-amber-500 border-amber-500 text-white' : 'bg-white border-slate-300'}`}>{keywordToEdit.important && <Icon path={ICONS.check} size={14} />}</div>
                           <span className="text-sm font-medium">Mark as Important</span>
                        </div>
                        <div className="flex gap-2 pt-2">
                           <button onClick={() => { deleteKeyword(keywordToEdit.id); setKeywordToEdit(null); }} className="flex-1 p-3 text-red-500 font-bold bg-red-50 rounded-xl">Delete</button>
                           <button onClick={() => setKeywordToEdit(null)} className="flex-1 p-3 text-slate-500 font-bold">Cancel</button>
                           <button onClick={() => { saveKeyword(keywordToEdit); setKeywordToEdit(null); }} className="flex-1 p-3 bg-indigo-600 text-white font-bold rounded-xl">Save</button>
                        </div>
                     </div>
                  </div>
               </div>
            )}

            {showSettings && (
              <div className="bg-slate-800 text-white p-4 space-y-4 absolute top-16 left-0 right-0 z-40 shadow-xl">
                 {deferredPrompt && <button onClick={installApp} className="flex items-center gap-2 w-full p-3 bg-indigo-600 rounded-lg font-bold shadow-lg text-white"><Icon path={ICONS.download} /> Install App</button>}
                 <button onClick={() => { if(confirm("Clear keywords?")) { setSavedSearches([]); localStorage.removeItem('docusearch_keywords_v2'); }}} className="flex items-center gap-2 w-full p-3 bg-slate-700 rounded-lg"><Icon path={ICONS.trash} /> Clear Knowledge Graph</button>
                 <button onClick={() => { if(confirm("Reset App?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); }}} className="flex items-center gap-2 w-full p-3 bg-red-900/50 rounded-lg border border-red-700"><Icon path={ICONS.trash} /> Reset All Data</button>
              </div>
            )}

            <div className="flex-1 overflow-hidden relative flex flex-col md:flex-row">
              <div className={`flex-1 flex flex-col min-h-0 bg-slate-50 transition-transform duration-300 ${isViewerOpen ? '-translate-x-1/3 opacity-50 pointer-events-none' : ''}`}>
                 <div className="p-4 space-y-3 bg-white border-b border-slate-100">
                    <div className="relative flex gap-2">
                       <div className="relative flex-1">
                          <div className="absolute left-3 top-3 text-slate-400"><Icon path={ICONS.search} size={16} /></div>
                          <input type="text" placeholder="Search..." className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                       </div>
                       {searchQuery.trim() && <button onClick={() => toggleQuickSave(searchQuery)} className={`p-3 rounded-xl transition-colors ${savedSearches.some(s => s.term.toLowerCase() === searchQuery.toLowerCase()) ? 'bg-yellow-50 text-yellow-500 border border-yellow-200' : 'bg-slate-100 text-slate-400'}`}><Icon path={savedSearches.some(s => s.term.toLowerCase() === searchQuery.toLowerCase()) ? ICONS.starFilled : ICONS.star} /></button>}
                    </div>
                    {allTags.length > 0 && (
                       <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                          <button onClick={() => setActiveTagFilter(null)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap ${!activeTagFilter ? 'bg-slate-800 text-white' : 'bg-slate-200'}`}>All</button>
                          {allTags.map(t => <button key={t} onClick={() => setActiveTagFilter(t===activeTagFilter?null:t)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap ${activeTagFilter===t?'bg-indigo-600 text-white':'bg-indigo-50 text-indigo-600'}`}>#{t}</button>)}
                       </div>
                    )}
                    <button onClick={() => fileInputRef.current.click()} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow active:scale-95 transition-transform flex justify-center gap-2"><Icon path={ICONS.upload} size={18} /> Import PDFs</button>
                    <input type="file" ref={fileInputRef} multiple accept=".pdf" className="hidden" onChange={handleFileSelect} />
                    {(processingQueue.length > 0 || statusMsg) && <div className="bg-indigo-50 p-2 rounded-lg border border-indigo-100 text-xs text-indigo-700 text-center font-mono animate-pulse">{statusMsg || `Queue: ${processingQueue.length} files remaining...`}</div>}
                 </div>

                 <div className="flex-1 overflow-y-auto p-4 pb-20">
                    {searchQuery ? (
                       <div className="space-y-3">{searchResults.map((r,i) => (
                          <div key={i} onClick={() => handleView(r.fileId, r.page)} className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm active:bg-slate-50 flex gap-3">
                             {r.thumbnail && <img src={r.thumbnail} className="w-12 h-16 object-cover rounded bg-slate-100" />}
                             <div><div className="font-bold text-sm">{r.fileName}</div><div className="text-xs text-slate-500 line-clamp-2 italic">"{r.snippet}"</div></div>
                          </div>
                       ))}</div>
                    ) : (
                       <div className={viewMode==='list'?'space-y-2':'grid-layout'}>
                          {filteredFiles.map(f => (
                             <div key={f.id} onClick={() => handleView(f.id)} className={`bg-white border border-slate-200 shadow-sm overflow-hidden active:scale-95 transition-transform ${viewMode==='list'?'flex gap-3 p-3 rounded-xl items-center':'rounded-xl'}`}>
                                <div className={`${viewMode==='list'?'w-10 h-12':'h-28'} bg-slate-100 flex items-center justify-center shrink-0`}>
                                   {f.thumbnail ? <img src={f.thumbnail} className="w-full h-full object-cover" /> : <span className="text-xs font-bold text-slate-400">PDF</span>}
                                </div>
                                <div className={viewMode==='grid'?'p-2':'flex-1'}>
                                   <div className="font-bold text-sm truncate text-slate-700">{f.name}</div>
                                   <div className="flex gap-1 overflow-hidden mt-1">{f.tags?.map(t => <span key={t} className="text-[9px] bg-indigo-50 text-indigo-600 px-1 rounded font-bold">#{t}</span>)}</div>
                                </div>
                             </div>
                          ))}
                       </div>
                    )}
                 </div>
              </div>

              <div className={`absolute inset-0 bg-white z-30 flex flex-col transition-transform duration-300 ${isViewerOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                 <div className="px-4 py-3 border-b border-slate-100 flex flex-col gap-3 shrink-0 pt-safe-top bg-white shadow-sm z-20">
                    <div className="flex items-center justify-between">
                       <div className="flex items-center gap-2">
                          <button onClick={() => setIsViewerOpen(false)} className="p-2 -ml-2 rounded-full hover:bg-slate-50"><Icon path={ICONS.arrowLeft} /></button>
                          {selectedFile?.toc?.length > 0 && <button onClick={() => setShowToC(!showToC)} className={`p-2 rounded-lg flex items-center gap-1 text-xs font-bold ${showToC?'bg-indigo-100 text-indigo-700':'bg-slate-100 text-slate-600'}`}><Icon path={ICONS.listIcon} size={16} /> Index</button>}
                       </div>
                       <button onClick={speakText} className={`p-2 rounded-full ${isSpeaking?'bg-red-100 text-red-600':'bg-indigo-50 text-indigo-600'}`}><Icon path={isSpeaking?ICONS.stop:ICONS.speaker} size={18} /></button>
                    </div>
                    <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1 items-center">
                       {selectedFile?.tags?.map(t => <span key={t} onClick={() => removeTag(t)} className="px-2 py-1 bg-indigo-600 text-white text-xs rounded-full flex items-center gap-1">#{t} <span className="opacity-50">x</span></span>)}
                       <input type="text" placeholder="+ Tag" className="bg-slate-100 text-xs px-2 py-1 rounded-full w-16 focus:w-24 outline-none" onKeyDown={(e) => { if(e.key === 'Enter') { addTag(e.target.value); e.target.value = ''; }}} />
                    </div>
                 </div>

                 <div className="flex-1 relative overflow-hidden">
                    <div className="absolute inset-0 overflow-y-auto p-6 bg-white">
                       <div className="max-w-prose mx-auto pb-24">
                          <div className="text-xs text-slate-400 uppercase font-bold mb-4 border-b pb-2 tracking-wider flex justify-between"><span>Page {selectedFile?.page||1}</span><span>{selectedFile?.pageCount} Total</span></div>
                          <HighlightedText text={selectedFile?.textContent?.[(selectedFile?.page||1)-1] || "No text."} keywords={savedSearches} onLinkClick={handleKeywordClick} />
                       </div>
                    </div>
                    {showToC && (
                       <div className="absolute inset-y-0 left-0 w-3/4 bg-white border-r border-slate-200 shadow-2xl z-30 animate-in slide-in-from-left overflow-y-auto">
                          <div className="p-4 border-b border-slate-100 bg-slate-50 font-bold text-sm text-slate-600 sticky top-0">Table of Contents</div>
                          {selectedFile?.toc?.length > 0 ? <ToCList items={selectedFile.toc} /> : <div className="p-6 text-center text-slate-400 text-sm">No chapters found.</div>}
                       </div>
                    )}
                    <div className="absolute bottom-0 left-0 right-0 border-t border-slate-100 p-4 bg-white/95 backdrop-blur pb-safe-bottom z-10">
                       <div className="flex justify-between items-center max-w-md mx-auto">
                          <button disabled={(selectedFile?.page||1)<=1} onClick={() => setSelectedFile(p => ({...p, page: p.page-1}))} className="px-5 py-3 bg-slate-100 rounded-xl font-bold disabled:opacity-30">Prev</button>
                          <span className="text-xs font-mono text-slate-400">Pg {selectedFile?.page}</span>
                          <button disabled={(selectedFile?.page||1)>=(selectedFile?.pageCount||1)} onClick={() => setSelectedFile(p => ({...p, page: p.page+1}))} className="px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold disabled:opacity-30">Next</button>
                       </div>
                    </div>
                 </div>
              </div>
            </div>
          </div>
        );
      }
      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>


